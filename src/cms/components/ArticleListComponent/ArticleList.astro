---
import type {
ArticleListFragment,
ArticlePageExcerptFragment,
DisplaySettingsFragment,
} from '../../../../__generated/sdk';
import { getOptimizelySdk } from '../../../graphql/getSdk';
import type { ContentPayload } from '../../../graphql/shared/ContentPayload';
import { getDictionaryFromDisplaySettings } from '../../../graphql/shared/displaySettingsHelpers';
import { isEditContext } from '../../shared/utils.ts';
import ArticleListImage from './ArticleListImage.astro';
import { CMPClient } from '@optimarvin/opti-cmp-client';

const isCmsEdit = isEditContext(Astro.url);

export interface Props {
    key: string;
    data: ArticleListFragment;
    displaySettings: DisplaySettingsFragment[];
    contentPayload: ContentPayload;
}
const { key, data, displaySettings, contentPayload } = Astro.props as Props;
const currentSite = data.IncludeAllSites ? null : Astro.url.origin;
const articlesList = await getOptimizelySdk(contentPayload).getArticles({
    //@ts-ignore
    loc: contentPayload.loc,
    site: currentSite,
    limit: data.NumberOfArticles || 1,
    rootUrl: data.ArticleRoot?.url?.default || '/',
});
const items = articlesList.ArticlePage?.items || null;

// Helper function to resolve image from CMS or CMP
async function resolveImage(item: ArticlePageExcerptFragment) {
    const graphUrl = item.PromoImage?.url?.graph;

    // Determine image source: CMS or CMP
    const isStoredInCms = graphUrl?.startsWith('graph://cms/');
    const isStoredInCmp = graphUrl?.startsWith('graph://cmp/');

    let imageUrl: string | undefined;
    let altText: string | undefined;

    if (isStoredInCms) {
        // Image is in CMS - use existing logic
        imageUrl = (item.PromoImage as any)?.item?.Url || item.PromoImage?.url?.default;
        altText = (item.PromoImage as any)?.item?.AltText
            || (item.PromoImage as any)?.item?._metadata?.displayName
            || `Promo image for ${item.Heading}`
            || 'Article promo image';
    } else if (isStoredInCmp) {
        // Image is in CMP - fetch from CMP API
        try {
            // Extract image ID from graph URL (e.g., "graph://cmp/ImageMedia/e0ce37f5dcf0439dbf248785ba5b9a20")
            const imageId = graphUrl?.split('/').pop();

            if (imageId && import.meta.env.CMP_API_BASE_URL) {
                // Initialize CMP client
                const cmpClient = new CMPClient({
                    apiBaseUrl: import.meta.env.CMP_API_BASE_URL,
                    clientId: import.meta.env.CMP_OAUTH_CLIENT_ID,
                    clientSecret: import.meta.env.CMP_OAUTH_CLIENT_SECRET,
                    authServerUrl: import.meta.env.CMP_AUTH_SERVER_URL
                });

                // Fetch image from CMP
                const cmpImage = await cmpClient.getImage(imageId);
                imageUrl = cmpImage.url;
                altText = cmpImage.alt_text || cmpImage.title || `Promo image for ${item.Heading}` || 'Article promo image';
            }
        } catch (error) {
            console.error('[CMP Image Debug] Failed to fetch CMP image:', error);
            if (error instanceof Error && 'statusCode' in error && 'details' in error) {
                console.error('[CMP Image Debug] Status Code:', (error as any).statusCode);
                console.error('[CMP Image Debug] Details:', (error as any).details);
            }
            // Fallback to undefined on error
            imageUrl = undefined;
        }
    } else {
        // Fallback to default behavior
        imageUrl = (item.PromoImage as any)?.item?.Url || item.PromoImage?.url?.default;
        altText = (item.PromoImage as any)?.item?.AltText
            || (item.PromoImage as any)?.item?._metadata?.displayName
            || `Promo image for ${item.Heading}`
            || 'Article promo image';
    }

    return {
        url: imageUrl ?? '/article-list-placeholder.jpg',
        altText: altText || 'Article promo image'
    };
}

// Resolve all images
const itemsWithImages = items ? await Promise.all(
    items.filter((item): item is ArticlePageExcerptFragment => item !== null).map(async (item: ArticlePageExcerptFragment) => ({
        item,
        image: await resolveImage(item)
    }))
) : [];

// Get style settings from display settings
const styleDictionary = getDictionaryFromDisplaySettings(displaySettings);

// Container settings
const maxWidth = styleDictionary['maxWidth'] || 'none';
const contentAlignment = styleDictionary['contentAlignment'] || 'start';
const titleAlignment = styleDictionary['titleAlignment'] || 'start';

// Layout settings
const layoutStyle = styleDictionary['layoutStyle'] || 'grid';
const gridColumns = styleDictionary['gridColumns'] || 'col4';
const imagePosition = styleDictionary['imagePosition'] || 'top';
const buttonPosition = styleDictionary['buttonPosition'] || 'end';

// Build dynamic classes for cards based on settings
// Default to 'zoom_subtle' if no hover effect is specified
const hoverEffect = styleDictionary['hoverEffect'] || 'zoom_subtle';
const shadowValue = styleDictionary['cardShadow'] || 'sm';
const hoverShadowValue = styleDictionary['hoverShadow'] || 'lg';

// Container wrapper classes for max-width and alignment
const containerWrapperClasses = {
    // Max width
    'max-w-xs': maxWidth === 'xs',
    'max-w-sm': maxWidth === 'sm',
    'max-w-md': maxWidth === 'md',
    'max-w-lg': maxWidth === 'lg',
    'max-w-xl': maxWidth === 'xl',
    'max-w-2xl': maxWidth === 'tw_2xl',
    'max-w-3xl': maxWidth === 'tw_3xl',
    'max-w-4xl': maxWidth === 'tw_4xl',
    'max-w-5xl': maxWidth === 'tw_5xl',
    'max-w-6xl': maxWidth === 'tw_6xl',
    'max-w-7xl': maxWidth === 'tw_7xl',
    // Alignment
    'mx-auto': contentAlignment === 'center',
    'ml-auto': contentAlignment === 'right',
};

// Title alignment classes
const titleClasses = {
    'text-start': titleAlignment === 'left',
    'text-center': titleAlignment === 'center',
    'text-end': titleAlignment === 'right',
};

// Button alignment classes
const buttonClasses = {
    'justify-start': buttonPosition === 'start',
    'justify-end': buttonPosition === 'end',
    'justify-center': buttonPosition === 'center',
};

// Grid container classes based on settings
const gridContainerClasses = {
    // Grid layout
    'grid gap-8': layoutStyle === 'grid',
    'grid-cols-1': layoutStyle === 'grid',
    'sm:grid-cols-2': layoutStyle === 'grid' && (gridColumns === 'col2' || gridColumns === 'col3' || gridColumns === 'col4' || gridColumns === 'col5' || gridColumns === 'col6'),
    'lg:grid-cols-3': layoutStyle === 'grid' && (gridColumns === 'col3' || gridColumns === 'col4' || gridColumns === 'col5' || gridColumns === 'col6'),
    'xl:grid-cols-6': layoutStyle === 'grid' && gridColumns === 'col6',
    'xl:grid-cols-5': layoutStyle === 'grid' && gridColumns === 'col5',
    'xl:grid-cols-4': layoutStyle === 'grid' && gridColumns === 'col4',
    'xl:grid-cols-3': layoutStyle === 'grid' && gridColumns === 'col3',
    'xl:grid-cols-2': layoutStyle === 'grid' && gridColumns === 'col2',
    'xl:grid-cols-1': layoutStyle === 'grid' && gridColumns === 'col1',
    // List layout
    'flex flex-col gap-6': layoutStyle === 'list',
};

// Build dynamic card class list for style-based classes
const cardDynamicClasses = {
    // Layout direction
    'flex-row': layoutStyle === 'list' && imagePosition === 'left',
    'flex-row-reverse': layoutStyle === 'list' && imagePosition === 'right',
    'flex-col': imagePosition === 'top' || layoutStyle === 'grid',
    // Override default shadow if specified
    'shadow-none': shadowValue === 'none',
    'shadow-md': shadowValue === 'md',
    'shadow-lg': shadowValue === 'lg',
    'shadow-xl': shadowValue === 'xl',
    // Hover shadow classes
    'hover:shadow-md': hoverShadowValue === 'md',
    'hover:shadow-lg': hoverShadowValue === 'lg',
    'hover:shadow-xl': hoverShadowValue === 'xl',
    'hover:shadow-2xl': hoverShadowValue === 'xxl',
    // Hover zoom effects
    'transition-transform duration-300 hover:scale-105': hoverEffect === 'zoom',
    'transition-transform duration-300 hover:scale-[1.02]': hoverEffect === 'zoom_subtle',
    // Add overflow hidden for zoom effects
    'overflow-hidden': hoverEffect === 'zoom' || hoverEffect === 'zoom_subtle',
};

// Figure classes for horizontal layout
const figureClasses = {
    'w-1/3 flex-shrink-0': layoutStyle === 'list' && (imagePosition === 'left' || imagePosition === 'right'),
};

const componentClass = 'component-articlelist';
---

<div data-epi-block-id={isCmsEdit && key || undefined} class={componentClass}>
    <div class="w-full" class:list={[containerWrapperClasses]}>
        <h1 class="w-full basis-full" class:list={[titleClasses]}>{data?.Title}</h1>
        <div class="mt-4 mb-4" class:list={[gridContainerClasses]}>
            {
                itemsWithImages.map(({ item, image }) => (
                    <ArticleListImage
                        item={item}
                        imageUrl={image.url}
                        altText={image.altText}
                        cardDynamicClasses={cardDynamicClasses}
                        figureClasses={figureClasses}
                        buttonClasses={buttonClasses}
                    />
                ))
            }
        </div>
    </div>
</div>