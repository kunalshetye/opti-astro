---
import type {
    DisplaySettingsFragment,
    OptiFormsChoiceElement,
} from '../../../../__generated/sdk';
import type { ContentPayload } from '../../../graphql/shared/ContentPayload';
import { requiredValidatorMsg } from '../formHelper';

// https://daisyui.com/components/input/

//// Example of Options JSON structure:
// "Options": [
//   {
//     "label": "Choice 1",
//     "value": "Choice 1",
//     "selected": false
//   },
//   {
//     "label": "Choice 2",
//     "value": "Choice 2",
//     "selected": false
//   }
// ],
// "AllowMultiSelect": true,

export interface Props {
    data: OptiFormsChoiceElement;
    contentPayload: ContentPayload;
    displaySettings: DisplaySettingsFragment[];
    Label?: string;
    Tooltip?: string;
    Options?: any;
    Validators?: any;
    AllowMultiSelect?: boolean;
}
const { data, displaySettings } = Astro.props as Props;
const { Label, Tooltip, Options, Validators, AllowMultiSelect } = data;

const isRequiredErrorMsg = requiredValidatorMsg(Validators);
const inputId = Label?.replace(/\s+/g, '_') || `choice-${Math.random().toString(36).substr(2, 4)}`;
const legendId = `${inputId}-legend`;
const instructionsId = `${inputId}-instructions`;

// Generate error IDs for ARIA
const errorIds = [
    isRequiredErrorMsg && `${inputId}-required-error`
].filter(Boolean).join(' ');

const describedByIds = [
    instructionsId,
    errorIds
].filter(Boolean).join(' ');

// Determine input type and role based on AllowMultiSelect
const inputType = AllowMultiSelect ? 'checkbox' : 'radio';
const groupRole = AllowMultiSelect ? 'group' : 'radiogroup';
const inputClass = AllowMultiSelect ? 'checkbox' : 'radio';
const instructionText = AllowMultiSelect 
    ? (isRequiredErrorMsg ? "Select at least one option" : "Select one or more options")
    : "Select one option. Use arrow keys to navigate.";
---

<fieldset class="form-control w-full rounded-2xl bg-base-100 border border-base-300 p-5 shadow-sm
                    transition-all duration-200 ease-in-out hover:shadow-md">
    <legend id={legendId} class="px-2 text-base font-medium text-base-content/80">
        {Label}
        {isRequiredErrorMsg && <span class="text-error ml-1" aria-label="required">*</span>}
    </legend>

    <p id={instructionsId} class="text-sm text-base-content/60 mb-3">
        {instructionText}
    </p>

    <div
        class="flex flex-row flex-wrap gap-x-8 gap-y-3"
        role={groupRole}
        aria-labelledby={legendId}
        aria-describedby={describedByIds}
        {...(!AllowMultiSelect && { 'aria-required': isRequiredErrorMsg ? "true" : "false" })}
    >
        {(Array.isArray(Options) ? Options : []).map(
            (opt: { label: string; value: string; selected?: boolean }, idx: number) => {
                const optionId = `${inputId}-${inputType}-${idx}`;
                return (
                    <label class="label cursor-pointer justify-start gap-3 p-2 rounded-lg
                                  transition-all duration-150 ease-in-out
                                  hover:bg-base-200/50" for={optionId}>
                        <input
                            id={optionId}
                            name={inputId}
                            type={inputType}
                            class={`${inputClass} ${inputClass}-primary transition-all duration-150`}
                            value={opt.value}
                            checked={opt.selected}
                            required={isRequiredErrorMsg ? (AllowMultiSelect ? false : true) : false}
                        />
                        <span class="label-text text-base-content/90">{opt.label}</span>
                    </label>
                );
            }
        )}
    </div>

    <div class="mt-2 min-h-[1.25rem]">
        {isRequiredErrorMsg && (
            <p id={`${inputId}-required-error`} class="validator-hint hidden text-sm text-error animate-pulse">{isRequiredErrorMsg}</p>
        )}
    </div>
</fieldset>
