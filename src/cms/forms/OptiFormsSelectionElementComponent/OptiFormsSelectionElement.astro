---
// https://daisyui.com/components/select/

import type {
    DisplaySettingsFragment,
    OptiFormsSelectionElement,
} from '../../../../__generated/sdk';
import type { ContentPayload } from '../../../graphql/shared/ContentPayload';
import { requiredValidatorMsg } from '../formHelper';

//// Example of Selection JSON structure:
// "Options": [
//   {
//     "label": "Choice 1",
//     "value": "Choice 1",
//     "selected": false
//   },
//   {
//     "label": "Choice 2",
//     "value": "Choice 2",
//     "selected": false
//   }
// ],
// "AllowMultiSelect": true,

export interface Props {
    data: OptiFormsSelectionElement;
    contentPayload: ContentPayload;
    displaySettings: DisplaySettingsFragment[];
    Label?: string;
    Tooltip?: string;
    Options?: any;
    Validators?: any;
    AllowMultiSelect?: boolean;
    AutoComplete?: string;
}
const { data, displaySettings } = Astro.props as Props;
const { Label, Tooltip, Options: RawOptions, Validators, AllowMultiSelect, AutoComplete } =
    data;

const Options = typeof RawOptions === 'string' ? JSON.parse(RawOptions) : RawOptions;

const isRequiredErrorMsg = requiredValidatorMsg(Validators);
const inputId = Label?.replace(/\s+/g, '_') || `selection-${Math.random().toString(36).substr(2, 4)}`;

// Generate error IDs for ARIA
const errorIds = [
    isRequiredErrorMsg && `${inputId}-required-error`
].filter(Boolean).join(' ');

// Add helpful description for multi-select
const instructionText = AllowMultiSelect 
    ? "Hold Ctrl (or Cmd on Mac) to select multiple options"
    : "Select one option from the list";
const instructionsId = `${inputId}-instructions`;

const describedByIds = [
    instructionsId,
    errorIds
].filter(Boolean).join(' ');
---

<fieldset class="form-control w-full rounded-2xl bg-base-100 border border-base-300 p-5 shadow-sm
                    transition-all duration-200 ease-in-out hover:shadow-md">
    <legend class="px-2 text-base font-medium text-base-content/80">
        {Label}
        {isRequiredErrorMsg && <span class="text-error ml-1" aria-label="required">*</span>}
    </legend>

    <p id={instructionsId} class="text-sm text-base-content/60 mb-3">
        {instructionText}
    </p>

    <select
        class:list={[
            "select select-bordered w-full rounded-xl bg-base-100 border-base-300 shadow-sm",
            "transition-all duration-200 ease-in-out",
            "hover:border-primary/50 hover:shadow-md",
            "focus:border-primary focus:ring-2 focus:ring-primary/20 focus:shadow-md focus:outline-none",
            AllowMultiSelect && "h-auto"
        ]}
        id={inputId}
        name={AllowMultiSelect ? `${inputId}[]` : inputId}
        autocomplete={AutoComplete || 'off'}
        multiple={AllowMultiSelect}
        required={isRequiredErrorMsg ? true : false}
        aria-describedby={describedByIds}
        title={Tooltip}
        size={AllowMultiSelect ? Math.min(Math.max((Options?.length || 1) + 1, 5), 8) : undefined}
        data-msg-required={isRequiredErrorMsg}
    >
        {!AllowMultiSelect && (
            <option value="" disabled selected class="text-base-content/40">
                {Tooltip || "Choose an option..."}
            </option>
        )}
        {(Array.isArray(Options) ? Options : []).map(
            (opt: { label: string; value: string; selected?: boolean }) => (
                <option value={opt.value} selected={opt.selected}>
                    {opt.label}
                </option>
            )
        )}
    </select>

    <div class="mt-2">
        {isRequiredErrorMsg && (
            <p class="validator-hint hidden text-sm text-error animate-pulse">{isRequiredErrorMsg}</p>
        )}
    </div>
</fieldset>
