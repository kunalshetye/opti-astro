---
import type {
    DisplaySettingsFragment,
    OptiFormsTextboxElement,
} from '../../../../__generated/sdk';
import type { ContentPayload } from '../../../graphql/shared/ContentPayload';
import {
    requiredValidatorMsg,
    emailValidatorMsg,
    numberValidatorMsg,
    regExpValidatorMsg,
    getRegularExpression,
} from '../formHelper';

// https://daisyui.com/components/input/

export interface Props {
    data: OptiFormsTextboxElement;
    contentPayload: ContentPayload;
    displaySettings: DisplaySettingsFragment[];
    Label?: string;
    Placeholder?: string;
    Tooltip?: string;
    PredefinedValue?: string;
    Validators?: any;
    AutoComplete?: string;
}
const { data, displaySettings } = Astro.props as Props;
const {
    Label,
    Placeholder,
    Tooltip,
    PredefinedValue,
    Validators,
    AutoComplete,
} = data;

const isRequiredErrorMsg = requiredValidatorMsg(Validators);
const isEmailErrorMsg = emailValidatorMsg(Validators);
const isRegExpErrorMsg = regExpValidatorMsg(Validators);

const regularExpressionValue = isRegExpErrorMsg
    ? getRegularExpression(Validators)
    : undefined;

const inputType =
    (isEmailErrorMsg && 'email') || 'text';

const inputId = Label?.replace(/\s+/g, '_') || `textbox-${Math.random().toString(36).substr(2, 4)}`;

const errorIds = [
    isRequiredErrorMsg && `${inputId}-required-error`,
    isRegExpErrorMsg && `${inputId}-regexp-error`,
    isEmailErrorMsg && `${inputId}-email-error`
].filter(Boolean).join(' ');
---

<div class="form-control w-full">
    <label class="label pb-1" for={inputId}>
        <span class="label-text text-base font-medium text-base-content/80">
            {Label}
            {isRequiredErrorMsg && <span class="text-error ml-1" aria-label="required">*</span>}
        </span>
    </label>

    <input
        id={inputId}
        name={inputId}
        type={inputType}
        class="input input-bordered w-full rounded-xl bg-base-100 border-base-300 shadow-sm
               transition-all duration-200 ease-in-out
               hover:border-primary/50 hover:shadow-md
               focus:border-primary focus:ring-2 focus:ring-primary/20 focus:shadow-md focus:outline-none
               placeholder:text-base-content/40"
        required={isRequiredErrorMsg ? true : false}
        aria-describedby={errorIds || undefined}
        placeholder={Placeholder}
        value={PredefinedValue}
        autocomplete={AutoComplete || 'off'}
        {...regularExpressionValue ? { pattern: regularExpressionValue } : {}}
        title={Tooltip}
        data-msg-required={isRequiredErrorMsg}
        data-msg-type={isEmailErrorMsg}
        data-msg-pattern={isRegExpErrorMsg}
    />

    <div class="mt-1.5">
        {isRequiredErrorMsg && (
            <p id={`${inputId}-required-error`} class="validator-hint hidden text-sm text-error animate-pulse">{isRequiredErrorMsg}</p>
        )}
        {isRegExpErrorMsg && (
            <p id={`${inputId}-regexp-error`} class="validator-hint hidden text-sm text-error animate-pulse">{isRegExpErrorMsg}</p>
        )}
        {isEmailErrorMsg && (
            console.log("Email error message:", isEmailErrorMsg),
            <p id={`${inputId}-email-error`} class="validator-hint hidden text-sm text-error animate-pulse">{isEmailErrorMsg}</p>
        )}
    </div>
</div>
