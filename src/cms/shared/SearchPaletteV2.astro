---
// SearchPaletteV2.astro - Search palette with FacetedSearch component
import FacetedSearchClient from '../components/FacetedSearchComponent/FacetedSearch.svelte';

const currentLocale = Astro.currentLocale;
const domain = Astro.url.origin;

// Configuration for modal mode
const config = {
	resultsPerPage: 10,
	gridColumns: 2,
	defaultViewMode: 'list',
	defaultFiltersState: 'hide',
	defaultSortOrder: 'relevance',
	showSearchInput: true,
	showAuthorFacet: true,
	showTypeFacet: true,
	searchPlaceholder: 'Search...',
	noResultsMessage: 'No results found. Try adjusting your filters.',
	locale: currentLocale || 'en',
	domain: domain,
	useSemanticSearch: true,
	semanticWeight: 0.3,
};

// Empty initial data - all fetching will be client-side
const initialResults: any[] = [];
const initialFacets = { authors: [], types: [] };
const initialTotal = 0;
---

<div
	x-data="searchPaletteV2()"
	data-locale={currentLocale}
	x-show="isOpen"
	x-cloak
	@keydown.escape.window="closeModal()"
	@open-command-palette.window="openModal()"
	class="fixed inset-0 z-50"
	style="display: none;"
>
	<!-- Overlay -->
	<div
		class="bg-neutral/60 fixed inset-0 backdrop-blur-sm"
		aria-hidden="true"
		x-show="isOpen"
		x-transition:enter="transition ease-out duration-200"
		x-transition:enter-start="opacity-0"
		x-transition:enter-end="opacity-100"
		x-transition:leave="transition ease-in duration-150"
		x-transition:leave-start="opacity-100"
		x-transition:leave-end="opacity-0"
		@click="closeModal()"
	>
	</div>

	<!-- Dialog container -->
	<div
		class="fixed inset-0 z-10 overflow-y-auto p-4 sm:p-6 md:p-20"
		x-transition:enter="transition ease-out duration-200"
		x-transition:enter-start="opacity-0 scale-95"
		x-transition:enter-end="opacity-100 scale-100"
		x-transition:leave="transition ease-in duration-150"
		x-transition:leave-start="opacity-100 scale-100"
		x-transition:leave-end="opacity-0 scale-95"
		@click.self="closeModal()"
	>
		<!-- Dialog panel -->
		<div
			class="bg-base-100 ring-base-300 relative mx-auto max-w-5xl transform overflow-hidden rounded-xl shadow-2xl ring-2 transition-all"
			@click.away="closeModal()"
		>
			<!-- Close button -->
			<button
				@click="closeModal()"
				class="btn btn-circle btn-ghost btn-sm absolute top-4 right-4 z-10"
				aria-label="Close search"
			>
				<svg
					xmlns="http://www.w3.org/2000/svg"
					class="h-6 w-6"
					fill="none"
					viewBox="0 0 24 24"
					stroke="currentColor"
				>
					<path
						stroke-linecap="round"
						stroke-linejoin="round"
						stroke-width="2"
						d="M6 18L18 6M6 6l12 12"
					/>
				</svg>
			</button>

			<!-- FacetedSearch Component -->
			<div class="p-6">
				<FacetedSearchClient
					client:load
					initialResults={initialResults}
					initialFacets={initialFacets}
					initialTotal={initialTotal}
					config={config}
					baseUrl=""
					isEditMode={false}
					isModal={true}
					compact={true}
					persistState={true}
					onResultClick={(result: any) => {
						// Navigate to result and close modal
						if (result._metadata?.url?.hierarchical) {
							window.location.href = result._metadata.url.hierarchical;
						}
					}}
				/>
			</div>
		</div>
	</div>
</div>

<style is:global>
	[x-cloak] {
		display: none !important;
	}
</style>

<script is:inline>
	function searchPaletteV2() {
		return {
			isOpen: false,

			init() {
				this.isOpen = false;
			},

			openModal() {
				this.isOpen = true;
				// Focus will be handled by the search input in FacetedSearch component
			},

			closeModal() {
				this.isOpen = false;
			},
		};
	}
</script>

<style>
	#search-palette-v2 {
		position: fixed !important;
		top: 0 !important;
		right: 0 !important;
		bottom: 0 !important;
		left: 0 !important;
		z-index: 9999 !important;
	}
</style>
